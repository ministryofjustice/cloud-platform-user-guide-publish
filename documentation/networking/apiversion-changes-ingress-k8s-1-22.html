<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Removing Deprecated Ingress APIs for Cloud Platform - Kubernetes v1.22 - Cloud Platform User Guide</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://user-guide.cloud-platform.service.justice.gov.uk/documentation/networking/apiversion-changes-ingress-k8s-1-22.html">

      <meta name="robots" content="noindex" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="user-guide.cloud-platform.service.justice.gov.uk" />
      <meta name="twitter:image" content="https://user-guide.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="Removing Deprecated Ingress APIs for Cloud Platform - Kubernetes v1.22 - Cloud Platform User Guide" />
      <meta name="twitter:url" content="https://user-guide.cloud-platform.service.justice.gov.uk/documentation/networking/apiversion-changes-ingress-k8s-1-22.html" />

      <meta property="og:image" content="https://user-guide.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="Cloud Platform User Guide" />
      <meta property="og:title" content="Removing Deprecated Ingress APIs for Cloud Platform - Kubernetes v1.22" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://user-guide.cloud-platform.service.justice.gov.uk/documentation/networking/apiversion-changes-ingress-k8s-1-22.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          Cloud Platform User Guide
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="mailto:platforms+user-guide@digital.justice.gov.uk?subject=User+guide+feedback">Feedback / Report a problem</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Documentation</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://github.com/ministryofjustice/cloud-platform-user-guide">GitHub</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://user-guide.cloud-platform.service.justice.gov.uk"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="assertive" role="alert">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#removing-deprecated-ingress-apis-for-cloud-platform-kubernetes-v1-22"><span>Removing Deprecated Ingress APIs for Cloud Platform - Kubernetes v1.22</span></a>
    <ul>
      <li>
        <ul>
          <li>
            <a href="#resources-deployed-using-kubectl"><span>Resources deployed using kubectl</span></a>
          </li>
          <li>
            <a href="#resources-deployed-using-a-helm-chart"><span>Resources deployed using a helm chart</span></a>
          </li>
          <li>
            <a href="#getting-help"><span>Getting help</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <h1 id="removing-deprecated-ingress-apis-for-cloud-platform-kubernetes-v1-22">Removing Deprecated Ingress APIs for Cloud Platform - Kubernetes v1.22</h1><p>All beta Ingress API versions such as <code>extensions/v1beta1</code> and <code>networking.k8s.io/v1beta1</code> have been deprecated and are not available in Kubernetes v1.22 or the new nginx-ingress-controller v1.2</p>
<p>This user guide describes how to use the following stable Ingress API which is required for <strong>all</strong> ingresses:</p>

<ul>
<li><code>networking.k8s.io/v1</code></li>
</ul>
<p>The replacement Ingress v1 API is available within the current Cloud Platform Kubernetes version 1.21 and nginx-ingress-controller v0.47.0</p>
<p>To view which apiVersion you are using, run the following kubectl command:</p>
<p><code>kubectl --namespace &lt;namespace&gt; get ingress &lt;ingress-name&gt; -o yaml</code></p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>apiVersion: networking.k8s.io/v1
kind: Ingress
</code></pre></div><h3 id="resources-deployed-using-kubectl">Resources deployed using kubectl</h3><p>If your ingress is using a beta version of the ingress API, it should look similar to the following:</p>

<pre>
apiVersion: <b>networking.k8s.io/v1beta1</b> OR <b>extensions/v1beta1</b>
kind: Ingress
metadata:
  name: helloworld
  annotations:
    kubernetes.io/ingress.class: nginx
    external-dns.alpha.kubernetes.io/set-identifier: helloworld-mynamespace-green
    external-dns.alpha.kubernetes.io/aws-weight: "100"
spec:
  tls:
  - hosts:
    - helloworld-app.apps.live.cloud-platform.service.justice.gov.uk
  rules:
  - host: helloworld-app.apps.live.cloud-platform.service.justice.gov.uk
    http:
      paths:
      - <b>path: /
        backend:
          serviceName: helloworld
          servicePort: 4567</b>
</pre>
<p>Convert the manifest to use the <code>networking.k8s.io/v1</code> API version syntax:</p>

<ul>
<li>Change the <code>apiVersion</code> to <code>networking.k8s.io/v1</code></li>
<li>Add <code>pathType: ImplementationSpecific</code> after <code>path: /</code></li>
<li>For serviceName, rename <code>-backend.serviceName</code> to <code>-backend.service.name</code></li>
<li>For String servicePort, rename <code>-backend.servicePort</code> to <code>-backend.service.port.name</code></li>
<li>For Numeric servicePort, rename <code>-backend.servicePort</code> to <code>-backend.service.port.number</code></li>
</ul>
<p>The manifest should look like the below after the changes:</p>

<pre>
apiVersion: <b>networking.k8s.io/v1</b>
kind: Ingress
metadata:
  name: helloworld
  annotations:
    kubernetes.io/ingress.class: nginx
    external-dns.alpha.kubernetes.io/set-identifier: helloworld-mynamespace-green
    external-dns.alpha.kubernetes.io/aws-weight: "100"
spec:
  tls:
  - hosts:
    - helloworld-app.apps.live.cloud-platform.service.justice.gov.uk
  rules:
  - host: helloworld-app.apps.live.cloud-platform.service.justice.gov.uk
    http:
      paths:
      - path: /
        <b>pathType: ImplementationSpecific
        backend:
          service:
            name: helloworld
            port:
              number: 4567</b>
</pre>
<p>To apply your changes:</p>
<p><code>kubectl apply --filename ingress.yaml --namespace &lt;namespace&gt;</code></p>
<h3 id="resources-deployed-using-a-helm-chart">Resources deployed using a helm chart</h3><p><strong>NOTE</strong> - Check the helm version</p>
<p>The Cloud Platform runs on Kubernetes v1.21 and is compatible with helm version 3.5.x. Please make sure you have the 
correct version installed before updating the manifest. If you are on older helm versions, you might get an error below:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>Error: UPGRADE FAILED: rendered manifests contain a new resource that already exists. 
Unable to continue with update: existing resource conflict: namespace: XXX, name: YYYY,
existing_kind: networking.k8s.io/v1, Kind=Ingress, new_kind: networking.k8s.io/v1, Kind=Ingress
</code></pre></div><p>If your ingress manifest looks similar to below:</p>

<pre>
{{- if .Values.ingress.enabled -}}
{{- $fullName := include "app.fullname" . -}}
{{- $ingressPath := .Values.ingress.path -}}
apiVersion: <b>networking.k8s.io/v1beta1</b>
kind: Ingress
metadata:
  name: {{ $fullName }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
  annotations:
  {{- with .Values.ingress.annotations }}
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  tls:
  {{- range .Values.ingress.hosts }}
  - hosts:
    - {{ .host }}
    {{ if .cert_secret }}secretName: {{ .cert_secret }}{{ end }}
  {{- end }}
  rules:
  {{- range .Values.ingress.hosts }}
    - host: {{ .host }}
      http:
        paths:
          - <b>path: {{ $ingressPath }}
            backend:
              serviceName: {{ $fullName }}
              servicePort: http</b>
  {{- end }}
{{- end }}
</pre>
<p>The manifest after changes will look like:</p>

<pre>
  {{- if .Values.ingress.enabled -}}
{{- $fullName := include "app.fullname" . -}}
{{- $ingressPath := .Values.ingress.path -}}
apiVersion: <b>networking.k8s.io/v1</b>
kind: Ingress
metadata:
  name: {{ $fullName }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
  annotations:
  {{- with .Values.ingress.annotations }}
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  tls:
  {{- range .Values.ingress.hosts }}
  - hosts:
    - {{ .host }}
    {{ if .cert_secret }}secretName: {{ .cert_secret }}{{ end }}
  {{- end }}
  rules:
  {{- range .Values.ingress.hosts }}
    - host: {{ .host }}
      http:
        paths:
          - <b>path: {{ $ingressPath }}
            pathType: ImplementationSpecific
            backend:
              service:
                name: {{ $fullName }}
                port: 
                  name: http</b>
  {{- end }}
{{- end }}

</pre>
<p>To apply your changes:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>helm upgrade -f &lt;values-file.yaml&gt; &lt;your-release&gt; &lt;your-chart&gt; --namespace &lt;your-namespace&gt;
</code></pre></div><h3 id="getting-help">Getting help</h3><p>If you have any questions, please contact us on <a href="https://mojdt.slack.com/messages/C57UPMZLY">#ask-cloud-platform</a> Slack channel.</p>


              <div data-module='page-expiry' data-last-reviewed-on="2022-06-23">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 23 March 2022.

        It needs to be reviewed again on 23 June 2022
.
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 23 June 2022.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide/blob/main/source/documentation/networking/apiversion-changes-ingress-k8s-1-22.html.md.erb">View source</a></li>
                <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide/issues/new?labels=bug&amp;title=Re:%20'Removing%20Deprecated%20Ingress%20APIs%20for%20Cloud%20Platform%20-%20Kubernetes%20v1.22'&amp;body=Problem%20with%20'Removing%20Deprecated%20Ingress%20APIs%20for%20Cloud%20Platform%20-%20Kubernetes%20v1.22'%20(https://user-guide.cloud-platform.service.justice.gov.uk/documentation/networking/apiversion-changes-ingress-k8s-1-22.html)">Report problem</a></li>
                <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-138188246-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138188246-1');
</script>

<script>
  // Add the current window.location to the body of the
  // feedback email message.
  function sendFeedback(mailto, event) {
    event.preventDefault();

    var body = "Feedback/Problem on page: " + window.location + "\n";
    var href = mailto + '&body=' + encodeURIComponent(body);

    window.location = href;
  }

  $(document).ready(function() {
    var feedbackLink = $('a[href^="mailto:"]:contains("Feedback")')[0];
    var mailto = feedbackLink.href;
    $(feedbackLink).on('click', function(event) { sendFeedback(mailto, event); });
  });
</script>
