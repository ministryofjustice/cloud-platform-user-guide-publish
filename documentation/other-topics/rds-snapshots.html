<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
      <meta name="robots" content="noindex">

    <title>RDS Snapshots - Cloud Platform User Guide</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://user-guide.cloud-platform.service.justice.gov.uk/documentation/other-topics/rds-snapshots.html">


      <meta property="og:image" content="https://user-guide.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="Cloud Platform User Guide" />
      <meta property="og:title" content="RDS Snapshots" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://user-guide.cloud-platform.service.justice.gov.uk/documentation/other-topics/rds-snapshots.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="user-guide.cloud-platform.service.justice.gov.uk" />
      <meta property="twitter:image" content="https://user-guide.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="RDS Snapshots - Cloud Platform User Guide" />
      <meta property="twitter:url" content="https://user-guide.cloud-platform.service.justice.gov.uk/documentation/other-topics/rds-snapshots.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          Cloud Platform User Guide
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="mailto:platforms+user-guide@digital.justice.gov.uk?subject=User+guide+feedback">Feedback / Report a problem</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Documentation</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://github.com/ministryofjustice/cloud-platform-user-guide">GitHub</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://user-guide.cloud-platform.service.justice.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#rds-snapshots"><span>RDS Snapshots</span></a>
    <ul>
      <li>
        <a href="#considerations"><span>Considerations</span></a>
      </li>
      <li>
        <a href="#restoring-live-services-from-an-rds-db-snapshot"><span>Restoring live services from an RDS DB snapshot</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <h1 id="rds-snapshots">RDS Snapshots</h1><p>RDS snapshots have multiple purposes: migrations, backups, etc. When RDS DB instances are created using the <a href="https://github.com/ministryofjustice/cloud-platform-terraform-rds-instance">Cloud Platform RDS terraform module</a> an IAM user account is created for management purposes. This user can create, delete, copy, and restore RDS snapshots.</p>
<p>Examples of managing RDS DB snapshots using the AWS CLI can be found in the <a href="https://github.com/ministryofjustice/cloud-platform-terraform-rds-instance#4-managing-rds-snapshots---backups-and-restores">README</a> within the <a href="https://github.com/ministryofjustice/cloud-platform-terraform-rds-instance">RDS terraform module</a></p>
<h2 id="considerations">Considerations</h2>
<ul>
<li>The amount of manual snapshots per AWS account is limited, so it&rsquo;s important to cleanup old snapshots</li>
<li>Daily snapshots are provided &ldquo;out of the box&rdquo;, and <strong>do not count</strong> towards the &ldquo;Manual Snapshots&rdquo; total</li>
<li>Managing snapshots is the teams&rsquo; responsibility (as are snapshot restores), so teams are responsible for cleaning up unneeded manual snapshots in order to avoid hitting our AWS account limits</li>
</ul>
<h2 id="restoring-live-services-from-an-rds-db-snapshot">Restoring live services from an RDS DB snapshot</h2><p>If you want to restore your production RDS DB instance from a previous snapshot, either because the database is corrupted or the whole database was deleted, here is the procedure:</p>
<h4 id="1-get-the-db-instance-identifier-of-the-db-instance-you-want-to-restore-using-the-cloud-platform-cli">1. Get the <code>db-instance-identifier</code> of the DB instance you want to restore, using the <a href="/documentation/getting-started/cloud-platform-cli.html">Cloud Platform CLI</a>;</h4><div class="highlight"><pre class="highlight shell"><code>cloud-platform decode-secret <span class="nt">-n</span> &lt;your namespace&gt; <span class="nt">-s</span> &lt;the secret storing your RDS details&gt;
</code></pre></div><p>Look for a line like this in the output;</p>
<div class="highlight"><pre class="highlight plaintext"><code>"rds_instance_address": "cloud-platform-xxxxxxxxxxxxxxxx.abcdefghijkl.eu-west-2.rds.amazonaws.com",
</code></pre></div><p>The <code>db-instance-identifier</code> is the <code>cloud-platform-xxxxxxxxxxxxxxxx</code> part.</p>
<h4 id="2-list-the-available-snapshots-using-the-aws-cli">2. List the available snapshots using the AWS CLI:</h4><div class="highlight"><pre class="highlight plaintext"><code>eval $(cloud-platform decode-secret -n &lt;your namespace&gt; -s &lt;the secret storing your RDS details&gt; --export-aws-credentials)
aws rds describe-db-snapshots --db-instance-identifier &lt;db-instance-identifier&gt;
</code></pre></div><p>The output will have a list of snapshots available for that RDS DB instance. Pick the <code>DBSnapshotIdentifier</code> from which you want the RDS to be restored.</p>
<h4 id="3-update-your-current-rds-manifest-file-usually-called-rds-tf-in-the-cloud-platform-environments-repo-to-include-snapshot-identifier-and-raise-the-pr">3. Update your current RDS manifest file (usually called <code>rds.tf</code>) in the <a href="https://github.com/ministryofjustice/cloud-platform-environments">cloud-platform-environments</a> repo to include <code>snapshot-identifier</code> and raise the PR.</h4><div class="highlight"><pre class="highlight plaintext"><code>snapshot_identifier = "rds:cloud-platform-XXXXX-2020-02-08-04-23"
</code></pre></div><p>For example:</p>
<div class="highlight"><pre class="highlight plaintext"><code>module "example_team_rds" {
    source               = "github.com/ministryofjustice/cloud-platform-terraform-rds-instance?ref=5.1"
    cluster_name           = var.cluster_name
    cluster_state_bucket   = var.cluster_state_bucket
    team_name              = var.team_name
    business-unit          = var.business-unit
    application            = var.application
    is-production          = var.is-production
    db_engine_version      = "11.4"
    environment-name       = var.environment-name
    infrastructure-support = var.infrastructure-support
    force_ssl              = "true"
    rds_family             = "postgres11"

    snapshot_identifier = "rds:cloud-platform-XXXXX-2020-02-08-04-23"

    providers = {
    # Can be either "aws.london" or "aws.ireland"
    aws = aws.london
    }
}
</code></pre></div><p>It is important to retain the original settings associated with the DB instance when restoring from the snapshot. So don&rsquo;t make any other changes to this file.</p>
<h4 id="4-contact-the-cloud-platform-team-about-the-restore-providing-the-db-instance-identifier-and-the-pr-raised">4. Contact the Cloud Platform team about the restore, providing the <code>db-instance-identifier</code> and the PR raised.</h4><h4 id="5-before-the-pr-can-be-merged-the-cloud-platform-team-have-to">5. Before the PR can be merged, the Cloud Platform team have to:</h4>
<ul>
<li>pause the concourse pipeline, and</li>
<li>rename the DB Instance via the AWS console</li>
</ul>
<p>This allows the pipeline to create the new DB Instance from the snapshot, using the same name and settings as the original, and preserves the database endpoint and credentials.</p>

<blockquote>
<p>Sometimes the pipeline throws an error: <code>InvalidParameterCombination: Cannot upgrade mariadb from 10.4.13 to 10.4.8</code>.</p>
<p>This will happen if AWS upgraded the minor version automatically and terraform stored the exact db_engine_version in its state.</p>
<p>To fix this, change the <code>db_engine_version</code> in your <code>rds.tf</code> from <code>10.4</code> to the one AWS upgraded to, in this case <code>10.4.13</code> and repeat the previous steps again.</p>
<p>Once the the terraform apply is successful, and the new DB instance has been created, revert the changes made for <code>db_engine_version</code>.</p>
</blockquote>
<h4 id="6-merge-the-pr-to-master-and-check-that-the-build-pipeline-creates-the-new-db-instance-with-the-same-identifier-and-endpoints-the-cloud-platform-team-can-also-apply-your-changes-manually-if-this-is-time-critical">6. Merge the PR to master and check that the build pipeline creates the new DB instance with the same identifier and endpoints. The Cloud Platform team can also apply your changes manually if this is time critical.</h4><p>Once the new DB instance is restored and available, your application should be able to access the database with the same database credentials and endpoint as before.</p>
<p>After you have verified that your DB instance and the database is working as expected, let the Cloud Platform team know so they can delete the old, renamed DB instance.</p>


              <div data-module='page-expiry' data-last-reviewed-on="2021-04-26">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 26 January 2021.

        It needs to be reviewed again on 26 April 2021
.
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 26 April 2021.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide/blob/main/source/documentation/other-topics/rds-snapshots.html.md.erb">View source</a></li>
                <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide/issues/new?labels=bug&amp;title=Re:%20'RDS%20Snapshots'&amp;body=Problem%20with%20'RDS%20Snapshots'%20(https://user-guide.cloud-platform.service.justice.gov.uk/documentation/other-topics/rds-snapshots.html)">Report problem</a></li>
                <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >Â© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-138188246-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138188246-1');
</script>

<script>
  // Add the current window.location to the body of the
  // feedback email message.
  function sendFeedback(mailto, event) {
    event.preventDefault();

    var body = "Feedback/Problem on page: " + window.location + "\n";
    var href = mailto + '&body=' + encodeURIComponent(body);

    window.location = href;
  }

  $(document).ready(function() {
    var feedbackLink = $('a[href^="mailto:"]:contains("Feedback")')[0];
    var mailto = feedbackLink.href;
    $(feedbackLink).on('click', function(event) { sendFeedback(mailto, event); });
  });
</script>
