<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Creating an ECR repository - Cloud Platform User Guide</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://user-guide.cloud-platform.service.justice.gov.uk/documentation/getting-started/ecr-setup.html">

      <meta name="robots" content="noindex" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="user-guide.cloud-platform.service.justice.gov.uk" />
      <meta name="twitter:image" content="https://user-guide.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="Creating an ECR repository - Cloud Platform User Guide" />
      <meta name="twitter:url" content="https://user-guide.cloud-platform.service.justice.gov.uk/documentation/getting-started/ecr-setup.html" />

      <meta property="og:image" content="https://user-guide.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="Cloud Platform User Guide" />
      <meta property="og:title" content="Creating an ECR repository" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://user-guide.cloud-platform.service.justice.gov.uk/documentation/getting-started/ecr-setup.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          Cloud Platform User Guide
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="mailto:platforms+user-guide@digital.justice.gov.uk?subject=User+guide+feedback">Feedback / Report a problem</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Documentation</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://github.com/ministryofjustice/cloud-platform-user-guide">GitHub</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://user-guide.cloud-platform.service.justice.gov.uk"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="assertive" role="alert">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#creating-an-ecr-repository"><span>Creating an ECR repository</span></a>
    <ul>
      <li>
        <a href="#introduction"><span>Introduction</span></a>
        <ul>
          <li>
            <a href="#creating-the-registry"><span>Creating the registry</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#accessing-the-credentials"><span>Accessing the credentials</span></a>
      </li>
      <li>
        <a href="#github-actions"><span>GitHub Actions</span></a>
      </li>
      <li>
        <a href="#managing-your-ecr-repository"><span>Managing your ECR repository</span></a>
        <ul>
          <li>
            <a href="#setting-up-circleci"><span>Setting up CircleCI</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#next-steps"><span>Next steps</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <h1 id="creating-an-ecr-repository">Creating an ECR repository</h1><h2 id="introduction">Introduction</h2><p>This document will guide you through the creation of an ECR (Elastic Container Registry) repository for your application&rsquo;s container image.</p>
<h3 id="creating-the-registry">Creating the registry</h3><p>You need to have the <a href="/documentation/getting-started/cloud-platform-cli.html">Cloud Platform CLI</a> tool installed.</p>

<ol>
<li><p>Clone the environments repo and create a new branch</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span>git clone git@github.com:ministryofjustice/cloud-platform-environments.git
<span class="nv">$ </span><span class="nb">cd </span>cloud-platform-environments
<span class="nv">$ </span>git checkout <span class="nt">-b</span> add_ecr
</code></pre></div></li>
<li><p>Navigate to your namespace directory</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span><span class="nb">cd </span>namespaces/live.cloud-platform.service.justice.gov.uk/<span class="nv">$your_service</span>
</code></pre></div></li>
<li><p>Use the CLI tool to create your ECR</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span>cloud-platform environment ecr create
</code></pre></div><p>This will create a <code>resources/ecr.tf</code> file in your namespace folder.</p></li>
<li><p>Update github variables</p>
<p>Ensure you have the below variables added to <code>variables.tf</code></p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>variable <span class="s2">"github_owner"</span> <span class="o">{</span>
description <span class="o">=</span> <span class="s2">"The GitHub organization or individual user account containing the app's code repo. Used by the Github Terraform provider. See: https://user-guide.cloud-platform.service.justice.gov.uk/documentation/getting-started/ecr-setup.html#accessing-the-credentials"</span>
default     <span class="o">=</span> <span class="s2">"ministryofjustice"</span>
<span class="o">}</span>

variable <span class="s2">"github_token"</span> <span class="o">{</span>
description <span class="o">=</span> <span class="s2">"Required by the Github Terraform provider"</span>
default     <span class="o">=</span> <span class="s2">""</span>
<span class="o">}</span>
</code></pre></div><p>If you have created your environment using <a href="/documentation/getting-started/cloud-platform-cli.html">Cloud Platform CLI</a>, this will be already added to the <code>variables.tf</code></p></li>
<li><p>Update provider block</p>
<p>Ensure the provider is added to the required_providers in versions.tf</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>    github <span class="o">=</span> <span class="o">{</span>
    <span class="nb">source</span> <span class="o">=</span> <span class="s2">"integrations/github"</span>
    <span class="o">}</span>
</code></pre></div><p>Ensure the provider configuration is added to the main.tf</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>    provider <span class="s2">"github"</span> <span class="o">{</span>
    token <span class="o">=</span> var.github_token
    owner <span class="o">=</span> var.github_owner
    <span class="o">}</span>
</code></pre></div><p>If you have created your environment using <a href="/documentation/getting-started/cloud-platform-cli.html">Cloud Platform CLI</a>, this will be already added to the <code>versions.tf</code></p></li>
<li><p>git add, commit and push to your branch</p></li>
<li><p>Raise a PR to have your change approved</p></li>
</ol>
<p>Once your pull request has been approved and merged, it will trigger the <a href="/documentation/other-topics/apply-pipeline.html">Apply Pipeline</a> which will create your ECR.</p>
<p>For more information about the terraform module being used, please read the documentation: <a href="https://github.com/ministryofjustice/cloud-platform-terraform-ecr-credentials#aws-ecr-terraform-module">ECR terraform module</a></p>
<h2 id="accessing-the-credentials">Accessing the credentials</h2><p>After your ECR has been created, there will be a <a href="https://kubernetes.io/docs/concepts/configuration/secret/">Kubernetes secret</a> in your namespace, called <code>ecr-repo-[namespace name]</code></p>
<p>The secret stores the IAM access keys to authenticate with the registry, and the actual repository URL.</p>
<p>Use the <a href="/documentation/getting-started/cloud-platform-cli.html">Cloud Platform CLI</a> to retrieve the credentials:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>cloud-platform decode-secret -n [namespace name] -s ecr-repo-[namespace name]
</code></pre></div><p>Look for the <code>access_key_id</code> and <code>secret_access_key</code> values.</p>
<h2 id="github-actions">GitHub Actions</h2><p>If you are using <a href="/documentation/deploying-an-app/github-actions-continuous-deployment.html">GitHub Actions</a> for your application deployment pipeline, the ECR module can automatically manage <a href="https://docs.github.com/en/actions/reference/encrypted-secrets">GitHub Actions Secrets</a> containing the ECR name, and the AWS access/secret keypair required to access it.</p>
<p>In the <code>resources/ecr.tf</code> file, you should see this section:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>  # Uncomment and provide repository names to create github actions secrets
  # containing the ECR name, AWS access key, and AWS secret key, for use in
  # github actions CI/CD pipelines
  # github_repositories = ["my-repo"]
</code></pre></div><p>To use this feature, uncomment the last line, and set the list of repositories in which you want the GitHub Actions Secrets to be created.</p>
<p>e.g. if you have two GitHub repositories in your project, called <code>ministryofjustice/frontend</code> and <code>ministryofjustice/backend</code>, you would change the last line to:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>github_repositories = ["frontend", "backend"]
</code></pre></div><p>Once your PR is merged, those repositories should have secrets named: <code>ECR_NAME</code>, <code>ECR_AWS_ACCESS_KEY_ID</code>, and <code>ECR_AWS_SECRET_KEY</code>. You can use these secrets in your GitHub Actions pipelines.</p>
<p>See the <a href="https://github.com/ministryofjustice/cloud-platform-terraform-ecr-credentials#aws-ecr-terraform-module">module documentation</a> for more information.</p>
<h2 id="managing-your-ecr-repository">Managing your ECR repository</h2><p>There is a maximum number of images per repository for Amazon Elastic Container Registry (ECR). If a new image is created and pushed to ECR on every code change, repositories can quickly fill up with new revisions. So it is important to regularly delete images which are no longer required.</p>
<p>You can delete an image with the AWS CLI using this <a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/delete_image.html">guide</a>.</p>
<p>You can create <a href="/documentation/monitoring-an-app/how-to-create-alarms.html#creating-your-own-custom-alerts">custom-alerts</a> to monitor the number of ECR images in your Repository using <a href="https://prometheus.cloud-platform.service.justice.gov.uk/graph?g0.range_input=1h&amp;g0.expr=aws_ecr_repository_image_count&amp;g0.tab=1">Prometheus ecr-metrics</a>.</p>
<h3 id="setting-up-circleci">Setting up CircleCI</h3><p>In your CircleCI project, go to the settings (the cog icon) and select &lsquo;AWS Permissions&rsquo; from the left hand menu. Fill in the IAM credentials from the kubernetes secret, and CircleCI will be able to pull images from your ECR. For more information please see <a href="https://circleci.com/docs/2.0/private-images/">the official docs</a>.</p>
<h2 id="next-steps">Next steps</h2><p>Try <a href="/documentation/deploying-an-app/app-deploy-helm.html#deploying-an-application-to-the-cloud-platform-with-helm">deploying an app</a> with <a href="https://helm.sh/">Helm</a>, a Kubernetes package manager, or <a href="/documentation/deploying-an-app/helloworld-app-deploy.html#deploying-a-39-hello-world-39-application-to-the-cloud-platform">deploying manually</a> by writing some custom YAML files.</p>


              <div data-module='page-expiry' data-last-reviewed-on="2022-10-29">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 29 July 2022.

        It needs to be reviewed again on 29 October 2022
.
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 29 October 2022.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide/blob/main/source/documentation/getting-started/ecr-setup.html.md.erb">View source</a></li>
                <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide/issues/new?labels=bug&amp;title=Re:%20'Creating%20an%20ECR%20repository'&amp;body=Problem%20with%20'Creating%20an%20ECR%20repository'%20(https://user-guide.cloud-platform.service.justice.gov.uk/documentation/getting-started/ecr-setup.html)">Report problem</a></li>
                <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >Â© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-138188246-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138188246-1');
</script>

<script>
  // Add the current window.location to the body of the
  // feedback email message.
  function sendFeedback(mailto, event) {
    event.preventDefault();

    var body = "Feedback/Problem on page: " + window.location + "\n";
    var href = mailto + '&body=' + encodeURIComponent(body);

    window.location = href;
  }

  $(document).ready(function() {
    var feedbackLink = $('a[href^="mailto:"]:contains("Feedback")')[0];
    var mailto = feedbackLink.href;
    $(feedbackLink).on('click', function(event) { sendFeedback(mailto, event); });
  });
</script>
